AWSTemplateFormatVersion: 2010-09-09

Description: >
  Pipeline for stable keycloak deployments
Parameters:
  ProjectName:
    Type: String
    Default: keycloak
  GitHubOwner:
    Type: String
    Default: tnwinc
  GitHubRepo:
    Type: String
    Default: platform-auth-keycloak
  GitHubBranch:
    Type: String
    Default: stable
  IntegrationAccountId:
    Type: String
    Default: "455920928861"
  StageAccountId:
    Type: String
    Default: "403172096194"
  ProductionAccountId:
    Type: String
    Default: "618036221923"
  LayerName:
    Type: String
    Default: oidc-endpoint-authorizer-nodejs

Resources:
  NavexKcContainerRepository:
    Type: AWS::ECR::Repository
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      RepositoryPolicyText: !Sub |
        {
          "Version": "2008-10-17",
          "Statement": [
            {
              "Sid": "AllowCrossAccountPush",
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  "arn:aws:iam::${IntegrationAccountId}:root",
                  "arn:aws:iam::${StageAccountId}:root",
                  "arn:aws:iam::${ProductionAccountId}:root"
                ]
              },
              "Action": [
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage"
              ]
            }
          ]
        }
      LifecyclePolicy:
        LifecyclePolicyText: |
          {"rules":[
            {
              "rulePriority":1,
              "description":"Expire images older than 14 days",
              "selection":{
                "tagStatus":"untagged","countType":"sinceImagePushed","countUnit":"days","countNumber":14
              },
              "action":{"type":"expire"}
            }
          ]}
  PackageCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: "navex-codebuild"
      EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/navex-pipeline"
      Description: Packages various cfn customresource
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: aws-inf/buildspec.package.yml
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: S3_BUCKET
            Value: !Sub navex-artifacts-${AWS::AccountId}-${AWS::Region}
          - Name: S3_PREFIX
            Value: !Ref AWS::StackName
  AuthPackageCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: "navex-codebuild"
      EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/navex-pipeline"
      Description: Packages keycloak lambdas
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: aws-inf/buildspec.auth.package.yml    
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: S3_BUCKET
            Value: !Sub navex-artifacts-${AWS::AccountId}-${AWS::Region}
          - Name: S3_PREFIX
            Value: !Ref AWS::StackName
  KCCodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: "navex-codebuild"
      EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/navex-pipeline"
      Description: Builds the keycloak project
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: aws-inf/buildspec.yml
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        Type: LINUX_CONTAINER
        PrivilegedMode: True
        EnvironmentVariables:
          - Name: ECR_REGION
            Value: !Ref AWS::Region
          - Name: REPOSITORY_URI
            Value: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${NavexKcContainerRepository}

  KCPRCodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: "navex-codebuild"
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        PrivilegedMode: True
      Source:
        Type: GITHUB
        Location: !Sub "https://github.com/${GitHubOwner}/${GitHubRepo}"
        BuildSpec: aws-inf/buildspec.prblocker.yml
        GitCloneDepth: 1
        ReportBuildStatus: true
      Triggers:
        Webhook: true
        FilterGroups:
          - 
            - Type: EVENT
              Pattern: PULL_REQUEST_CREATED,PULL_REQUEST_UPDATED
            - Type: BASE_REF
              Pattern: !Sub "^refs/heads/${GitHubBranch}$"
              ExcludeMatchedPattern: false

  TransformCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      ServiceRole: "navex-codebuild"
      EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/navex-pipeline"
      Description: Transforms / merges dc artifacts into template-configuration.json
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: app/aws-inf/buildspec.transform.yml
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        Type: LINUX_CONTAINER
      VpcConfig:
        SecurityGroupIds:
          - !ImportValue CodeBuildSecurityGroup
        Subnets:
          - !ImportValue CodeBuildSubnetAZ1
          - !ImportValue CodeBuildSubnetAZ2
        VpcId: !ImportValue CodeBuildVpcId    

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Ref GitHubRepo
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/navex-codepipeline
      ArtifactStores:
        - Region: us-east-1
          ArtifactStore:
            Type: S3
            Location: !Sub navex-artifacts-${AWS::AccountId}-us-east-1
            EncryptionKey: 
              Id: !Sub "arn:aws:kms:us-east-1:${AWS::AccountId}:alias/navex-pipeline"
              Type: KMS
        - Region: us-west-2
          ArtifactStore:
            Type: S3
            Location: !Sub navex-artifacts-${AWS::AccountId}-us-west-2
            EncryptionKey: 
              Id: !Sub "arn:aws:kms:us-west-2:${AWS::AccountId}:alias/navex-pipeline"
              Type: KMS
        - Region: eu-central-1
          ArtifactStore:
            Type: S3
            Location: !Sub navex-artifacts-${AWS::AccountId}-eu-central-1
            EncryptionKey: 
              Id: !Sub "arn:aws:kms:eu-central-1:${AWS::AccountId}:alias/navex-pipeline"
              Type: KMS
      Stages:
        - Name: Source
          Actions:
            - 
              Name: App
              Namespace: SourceVariables
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: "1"
                Provider: CodeStarSourceConnection
              Configuration:
                ConnectionArn: "arn:aws:codestar-connections:us-west-2:518070709175:connection/c628c7f1-e78b-4ea7-a936-aaa704d6eed1"
                FullRepositoryId: !Sub ${GitHubOwner}/${GitHubRepo}
                BranchName: !Ref GitHubBranch
                OutputArtifactFormat: "CODE_ZIP"
              OutputArtifacts:
                - Name: App
              RunOrder: 1
        - Name: Build
          Actions:
            - 
              Name: Build
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref KCCodeBuild
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: BuildOutput
              RunOrder: 1
            - 
              Name: PackageUsWest2
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref PackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-us-west-2"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: PackageUsWest2
              RunOrder: 1
            - 
              Name: PackageUsEast1
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref PackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-us-east-1"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: PackageUsEast1
              RunOrder: 1
            - 
              Name: PackageEuCentral1
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref PackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-eu-central-1"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: PackageEuCentral1
              RunOrder: 1
            - 
              Name: AuthPackageUsWest2
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref AuthPackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-us-west-2"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: AuthPackageUsWest2
              RunOrder: 1
            - 
              Name: AuthPackageUsEast1
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref AuthPackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-us-east-1"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: AuthPackageUsEast1
              RunOrder: 1
            - 
              Name: AuthPackageEuCentral1
              Region: !Ref AWS::Region
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref AuthPackageCodeBuildProject
                EnvironmentVariables: !Sub |
                  [
                    {"name":"S3_BUCKET","value": "navex-artifacts-${AWS::AccountId}-eu-central-1"}
                  ]
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: AuthPackageEuCentral1
              RunOrder: 1
            -
              Name: PutProjVersion
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPPutProjectVersion
                UserParameters: |
                  {
                    "DeploySpecFile": "App::aws-inf/deployspec.json",
                    "OutputFile": "build-record.json"
                  }
              InputArtifacts:
                - Name: App
              OutputArtifacts:
                - Name: ProjectVersion
              RunOrder: 2

        - Name: IntegrationAccount
          Actions:
            - 
              Name: GetDcArt_IntStable
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPGetDCArtFromBuildInfo
                UserParameters: !Sub |
                  {
                    "SourceProjectId": "${ProjectName}_navexint_us-west-2",
                    "DeploymentContext": "int-stable",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "ProjectIds": {"aws-inf": "aws-inf_navexint_us-west-2"}
                  }
              InputArtifacts:
                - Name: ProjectVersion
              OutputArtifacts:
                - Name: GetDcArt_IntStable
              RunOrder: 1
            -
              Name: MergeArtifacts_IntStable
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPMergeArtifacts
                UserParameters: |
                  {
                    "ArtifactPrefixMap":{
                      "GetDcArt_IntStable": "dc_art",
                      "App": "app"
                    }
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: GetDcArt_IntStable
                - Name: App
              OutputArtifacts:
                - Name: MergeArtifacts_IntStable
              RunOrder: 2
            - 
              Name: Transform_IntStable
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TransformCodeBuildProject
                EnvironmentVariables: |
                  [
                    {"name": "INCLUDE_ADMIN_USER_IMPORT", "value": "true", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: MergeArtifacts_IntStable
              OutputArtifacts:
                - Name: Transform_IntStable
              RunOrder: 3
            - 
              Name: FinalizedCfnConfig_IntStable
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json",
                      "BuildOutput::template-configuration.json", 
                      "Transform_IntStable::template-configuration.json" 
                    ],
                    "Json": {
                      "Parameters": {
                        "Subdomain": "id3",
                        "DnsHostedZone": "navex-int.com",
                        "DnsHostedZoneId": "Z3KPLDK2FOBNKU",
                        "Stage": "Development"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "int-stable",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      }
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: BuildOutput
                - Name: ProjectVersion
                - Name: Transform_IntStable
              OutputArtifacts:
                - Name: FinalizedCfnConfig_IntStable
              RunOrder: 4
            - 
              Name: CfnDeploy_IntStable
              Region: us-west-2
              RoleArn: !Sub arn:aws:iam::${IntegrationAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${IntegrationAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable
                TemplatePath: "PackageUsWest2::app.packaged.yml"
                TemplateConfiguration: "FinalizedCfnConfig_IntStable::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: PackageUsWest2
                - Name: FinalizedCfnConfig_IntStable
              OutputArtifacts:
                - Name: CfnDeploy_IntStable
              RunOrder: 5
            -
              Name: ConfigUpload_IntStable          
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              InputArtifacts:
                - Name: Transform_IntStable
                - Name: CfnDeploy_IntStable
              Configuration:
                FunctionName: CPS3Deploy
                UserParameters: !Sub |
                  {
                    "S3BucketName": "CfnDeploy_IntStable::stack-outputs.json:ConfigBucket",
                    "BaseDirectory": "transformed-import",
                    "PurgeDirectories": "enabled",
                    "ExcludeArtifactsFromUpload": ["CfnDeploy_IntStable"],
                    "AccountId": "${IntegrationAccountId}",
                    "Region": "us-west-2"
                  }
              RunOrder: 6
            - 
              Name: FinalizedCfnAuthConfig_IntStable
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: !Sub |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json"
                    ],
                    "Json": {
                      "Parameters": {
                        "KCBaseUrl": "CfnDeploy_IntStable::stack-outputs.json:Domain",
                        "LayerName": "${LayerName}-int-stable"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "int-stable",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: ProjectVersion
                - Name: CfnDeploy_IntStable
              OutputArtifacts:
                - Name: FinalizedCfnAuthConfig_IntStable
              RunOrder: 6
            - 
              Name: CfnAuthDeploy_IntStable_UsWest2
              Region: us-west-2
              RoleArn: !Sub arn:aws:iam::${IntegrationAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${IntegrationAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable-auth
                TemplatePath: "AuthPackageUsWest2::auth.packaged.yml"
                TemplateConfiguration: "FinalizedCfnAuthConfig_IntStable::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: AuthPackageUsWest2
                - Name: FinalizedCfnAuthConfig_IntStable
              OutputArtifacts:
                - Name: CfnAuthDeploy_IntStable_UsWest2
              RunOrder: 7
            -
              Name: ImportConfig_IntStable
              RunOrder: 7
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_IntStable::stack-outputs.json:CpConfigImportLambdaArn",
                    "Payload": {"ImportId":"{{ codepipeline_job_id }}"},
                    "AccountId": "${IntegrationAccountId}",
                    "Region": "us-west-2",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_IntStable
            -
              Name: PostDeployApiActions_IntStable
              RunOrder: 8
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_IntStable::stack-outputs.json:CpPostDeployLambdaArn",
                    "Payload": { "Actions": [ "rotate_client_secrets","clear_user_cache" ] },
                    "AccountId": "${IntegrationAccountId}",
                    "Region": "us-west-2",
                    "InvocationType": "RequestResponse",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_IntStable
            - 
              Name: PublishDeployment_IntStable
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPSetDeploymentContext
                UserParameters: !Sub |
                  {
                    "ProjectId": "${ProjectName}_navexint_us-west-2",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "DeploymentContext": "int-stable",
                    "JsonArtifactFiles": [
                      "CfnDeploy_IntStable::stack-outputs.json",
                      "CfnAuthDeploy_IntStable_UsWest2::stack-outputs.json"
                    ]
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: CfnDeploy_IntStable
                - Name: CfnAuthDeploy_IntStable_UsWest2                 
              RunOrder: 9

        - Name: StageEU
          Actions:
            - 
              Name: GetDcArt_StageEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPGetDCArtFromBuildInfo
                UserParameters: !Sub |
                  {
                    "SourceProjectId": "${ProjectName}_navexstage_eu-central-1",
                    "DeploymentContext": "stageEU",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "ProjectIds": {"aws-inf": "aws-inf_platform_navexstage_eu-central-1"}
                  }
              InputArtifacts:
                - Name: ProjectVersion
              OutputArtifacts:
                - Name: GetDcArt_StageEU
              RunOrder: 1
            -
              Name: MergeArtifacts_StageEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPMergeArtifacts
                UserParameters: |
                  {
                    "ArtifactPrefixMap":{
                      "GetDcArt_StageEU": "dc_art",
                      "App": "app"
                    }
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: GetDcArt_StageEU
                - Name: App
              OutputArtifacts:
                - Name: MergeArtifacts_StageEU
              RunOrder: 2
            - 
              Name: Transform_StageEU
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TransformCodeBuildProject
                EnvironmentVariables: |
                  [
                    {"name": "INCLUDE_ADMIN_USER_IMPORT", "value": "false", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: MergeArtifacts_StageEU
              OutputArtifacts:
                - Name: Transform_StageEU
              RunOrder: 3
            - 
              Name: FinalizedCfnConfig_StageEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json",
                      "BuildOutput::template-configuration.json", 
                      "Transform_StageEU::template-configuration.json" 
                    ],
                    "Json": {
                      "Parameters": {
                        "Subdomain": "id3",
                        "DnsHostedZone": "navex-stage.eu",
                        "DnsHostedZoneId": "Z343M2SX2SYHUN",
                        "Stage": "Production",
                        "DbaAccessCidr": "10.162.26.14/31"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "stageEU",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: BuildOutput
                - Name: ProjectVersion
                - Name: Transform_StageEU
              OutputArtifacts:
                - Name: FinalizedCfnConfig_StageEU
              RunOrder: 4
            - 
              Name: CfnDeploy_StageEU
              Region: eu-central-1
              RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable
                TemplatePath: "PackageEuCentral1::app.packaged.yml"
                TemplateConfiguration: "FinalizedCfnConfig_StageEU::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: PackageEuCentral1
                - Name: FinalizedCfnConfig_StageEU
              OutputArtifacts:
                - Name: CfnDeploy_StageEU
              RunOrder: 5
            -
              Name: ConfigUpload_StageEU          
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              InputArtifacts:
                - Name: Transform_StageEU
                - Name: CfnDeploy_StageEU
              Configuration:
                FunctionName: CPS3Deploy
                UserParameters: !Sub |
                  {
                    "S3BucketName": "CfnDeploy_StageEU::stack-outputs.json:ConfigBucket",
                    "BaseDirectory": "transformed-import",
                    "PurgeDirectories": "enabled",
                    "ExcludeArtifactsFromUpload": ["CfnDeploy_StageEU"],
                    "AccountId": "${StageAccountId}",
                    "Region": "eu-central-1"
                  }
              RunOrder: 6
            - 
              Name: FinalizedCfnAuthConfig_StageEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: !Sub |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json"
                    ],
                    "Json": {
                      "Parameters": {
                        "KCBaseUrl": "CfnDeploy_StageEU::stack-outputs.json:Domain",
                        "LayerName": "${LayerName}-stageEU"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "stageEU",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: ProjectVersion
                - Name: CfnDeploy_StageEU
              OutputArtifacts:
                - Name: FinalizedCfnAuthConfig_StageEU
              RunOrder: 6
            - 
              Name: CfnAuthDeploy_StageEU_EuCentral1
              Region: eu-central-1
              RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable-auth
                TemplatePath: "AuthPackageEuCentral1::auth.packaged.yml"
                TemplateConfiguration: "FinalizedCfnAuthConfig_StageEU::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: AuthPackageEuCentral1
                - Name: FinalizedCfnAuthConfig_StageEU
              OutputArtifacts:
                - Name: CfnAuthDeploy_StageEU_EuCentral1
              RunOrder: 7
            -
              Name: ImportConfig_StageEU
              RunOrder: 7
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_StageEU::stack-outputs.json:CpConfigImportLambdaArn",
                    "Payload": {"ImportId":"{{ codepipeline_job_id }}"},
                    "AccountId": "${StageAccountId}",
                    "Region": "eu-central-1",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_StageEU
            -
              Name: PostDeployApiActions_StageEU
              RunOrder: 8
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_StageEU::stack-outputs.json:CpPostDeployLambdaArn",
                    "Payload": { "Actions": [ "rotate_client_secrets","clear_user_cache" ] },
                    "AccountId": "${StageAccountId}",
                    "Region": "eu-central-1",
                    "InvocationType": "RequestResponse",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_StageEU
            - 
              Name: PublishDeployment_StageEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPSetDeploymentContext
                UserParameters: !Sub |
                  {
                    "ProjectId": "${ProjectName}_navexstage_eu-central-1",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "DeploymentContext": "stageEU",
                    "JsonArtifactFiles": [
                      "CfnDeploy_StageEU::stack-outputs.json",
                      "CfnAuthDeploy_StageEU_EuCentral1::stack-outputs.json"
                    ]
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: CfnDeploy_StageEU
                - Name: CfnAuthDeploy_StageEU_EuCentral1                 
              RunOrder: 9            
        - Name: StageUS
          Actions:
            - 
              Name: GetDcArt_StageUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPGetDCArtFromBuildInfo
                UserParameters: !Sub |
                  {
                    "SourceProjectId": "${ProjectName}_navexstage_us-east-1",
                    "DeploymentContext": "stageUS",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "ProjectIds": {"aws-inf": "aws-inf_platform_navexstage_us-east-1"}
                  }
              InputArtifacts:
                - Name: ProjectVersion
              OutputArtifacts:
                - Name: GetDcArt_StageUS
              RunOrder: 1
            -
              Name: MergeArtifacts_StageUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPMergeArtifacts
                UserParameters: |
                  {
                    "ArtifactPrefixMap":{
                      "GetDcArt_StageUS": "dc_art",
                      "App": "app"
                    }
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: GetDcArt_StageUS
                - Name: App
              OutputArtifacts:
                - Name: MergeArtifacts_StageUS
              RunOrder: 2
            - 
              Name: Transform_StageUS
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TransformCodeBuildProject
                EnvironmentVariables: |
                  [
                    {"name": "INCLUDE_ADMIN_USER_IMPORT", "value": "false", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: MergeArtifacts_StageUS
              OutputArtifacts:
                - Name: Transform_StageUS
              RunOrder: 3
            - 
              Name: FinalizedCfnConfig_StageUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json",
                      "BuildOutput::template-configuration.json", 
                      "Transform_StageUS::template-configuration.json" 
                    ],
                    "Json": {
                      "Parameters": {
                        "Subdomain": "id3",
                        "DnsHostedZone": "navex-stage.com",
                        "DnsHostedZoneId": "Z1GXJLTUOO7LYC",
                        "Stage": "Production",
                        "DesiredTaskCount": "3",
                        "DbaAccessCidr": "10.98.26.14/31"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "stageUS",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      }
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: BuildOutput
                - Name: ProjectVersion
                - Name: Transform_StageUS
              OutputArtifacts:
                - Name: FinalizedCfnConfig_StageUS
              RunOrder: 4
            - 
              Name: CfnDeploy_StageUS
              Region: us-east-1
              RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable
                TemplatePath: "PackageUsEast1::app.packaged.yml"
                TemplateConfiguration: "FinalizedCfnConfig_StageUS::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: PackageUsEast1
                - Name: FinalizedCfnConfig_StageUS
              OutputArtifacts:
                - Name: CfnDeploy_StageUS
              RunOrder: 5
            -
              Name: ConfigUpload_StageUS          
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              InputArtifacts:
                - Name: Transform_StageUS
                - Name: CfnDeploy_StageUS
              Configuration:
                FunctionName: CPS3Deploy
                UserParameters: !Sub |
                  {
                    "S3BucketName": "CfnDeploy_StageUS::stack-outputs.json:ConfigBucket",
                    "BaseDirectory": "transformed-import",
                    "PurgeDirectories": "enabled",
                    "ExcludeArtifactsFromUpload": ["CfnDeploy_StageUS"],
                    "AccountId": "${StageAccountId}",
                    "Region": "us-east-1"
                  }
              RunOrder: 6
            - 
              Name: FinalizedCfnAuthConfig_StageUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: !Sub |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json"
                    ],
                    "Json": {
                      "Parameters": {
                        "KCBaseUrl": "CfnDeploy_StageUS::stack-outputs.json:Domain",
                        "LayerName": "${LayerName}-stageUS"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "stageUS",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: ProjectVersion
                - Name: CfnDeploy_StageUS
              OutputArtifacts:
                - Name: FinalizedCfnAuthConfig_StageUS
              RunOrder: 6
            - 
              Name: CfnAuthDeploy_StageUS_UsEast1
              Region: us-east-1
              RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${StageAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable-auth
                TemplatePath: "AuthPackageUsEast1::auth.packaged.yml"
                TemplateConfiguration: "FinalizedCfnAuthConfig_StageUS::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: AuthPackageUsEast1
                - Name: FinalizedCfnAuthConfig_StageUS
              OutputArtifacts:
                - Name: CfnAuthDeploy_StageUS_UsEast1
              RunOrder: 7
            -
              Name: ImportConfig_StageUS
              RunOrder: 7
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_StageUS::stack-outputs.json:CpConfigImportLambdaArn",
                    "Payload": {"ImportId":"{{ codepipeline_job_id }}"},
                    "AccountId": "${StageAccountId}",
                    "Region": "us-east-1",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_StageUS
            -
              Name: PostDeployApiActions_StageUS
              RunOrder: 8
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_StageUS::stack-outputs.json:CpPostDeployLambdaArn",
                    "Payload": { "Actions": [ "rotate_client_secrets","clear_user_cache" ] },
                    "AccountId": "${StageAccountId}",
                    "Region": "us-east-1",
                    "InvocationType": "RequestResponse",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_StageUS
            - 
              Name: PublishDeployment_StageUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPSetDeploymentContext
                UserParameters: !Sub |
                  {
                    "ProjectId": "${ProjectName}_navexstage_us-east-1",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "DeploymentContext": "stageUS",
                    "JsonArtifactFiles": [
                      "CfnDeploy_StageUS::stack-outputs.json",
                      "CfnAuthDeploy_StageUS_UsEast1::stack-outputs.json"
                    ]
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: CfnDeploy_StageUS
                - Name: CfnAuthDeploy_StageUS_UsEast1                 
              RunOrder: 9
        - Name: ApproveDeployToProductionEU
          Actions:
            - Name: Production_EU_Manual_Gate
              RunOrder: 1
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Version: "1"
                Provider: Manual
        - Name: ProdEU
          Actions:
            - 
              Name: GetDcArt_ProdEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPGetDCArtFromBuildInfo
                UserParameters: !Sub |
                  {
                    "SourceProjectId": "${ProjectName}_navexprod_eu-central-1",
                    "DeploymentContext": "prodEU",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "ProjectIds": {"aws-inf": "aws-inf_platform_navexprod_eu-central-1"}
                  }
              InputArtifacts:
                - Name: ProjectVersion
              OutputArtifacts:
                - Name: GetDcArt_ProdEU
              RunOrder: 1
            -
              Name: MergeArtifacts_ProdEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPMergeArtifacts
                UserParameters: |
                  {
                    "ArtifactPrefixMap":{
                      "GetDcArt_ProdEU": "dc_art",
                      "App": "app"
                    }
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: GetDcArt_ProdEU
                - Name: App
              OutputArtifacts:
                - Name: MergeArtifacts_ProdEU
              RunOrder: 2
            - 
              Name: Transform_ProdEU
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TransformCodeBuildProject
                EnvironmentVariables: |
                  [
                    {"name": "INCLUDE_ADMIN_USER_IMPORT", "value": "false", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: MergeArtifacts_ProdEU
              OutputArtifacts:
                - Name: Transform_ProdEU
              RunOrder: 3
            - 
              Name: FinalizedCfnConfig_ProdEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json",
                      "BuildOutput::template-configuration.json", 
                      "Transform_ProdEU::template-configuration.json" 
                    ],
                    "Json": {
                      "Parameters": {
                        "Subdomain": "id3",
                        "DnsHostedZone": "navexone.eu",
                        "DnsHostedZoneId": "Z22ECC3Q0NT9H2",
                        "Stage": "Production",
                        "DesiredTaskCount": "3",
                        "DbaAccessCidr": "10.162.26.14/31"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "prodEU",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      }
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: BuildOutput
                - Name: ProjectVersion
                - Name: Transform_ProdEU
              OutputArtifacts:
                - Name: FinalizedCfnConfig_ProdEU
              RunOrder: 4
            - 
              Name: CfnDeploy_ProdEU
              Region: eu-central-1
              RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable
                TemplatePath: "PackageEuCentral1::app.packaged.yml"
                TemplateConfiguration: "FinalizedCfnConfig_ProdEU::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: PackageEuCentral1
                - Name: FinalizedCfnConfig_ProdEU
              OutputArtifacts:
                - Name: CfnDeploy_ProdEU
              RunOrder: 5
            -
              Name: ConfigUpload_ProdEU          
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              InputArtifacts:
                - Name: Transform_ProdEU
                - Name: CfnDeploy_ProdEU
              Configuration:
                FunctionName: CPS3Deploy
                UserParameters: !Sub |
                  {
                    "S3BucketName": "CfnDeploy_ProdEU::stack-outputs.json:ConfigBucket",
                    "BaseDirectory": "transformed-import",
                    "PurgeDirectories": "enabled",
                    "ExcludeArtifactsFromUpload": ["CfnDeploy_ProdEU"],
                    "AccountId": "${ProductionAccountId}",
                    "Region": "eu-central-1"
                  }
              RunOrder: 6
            - 
              Name: FinalizedCfnAuthConfig_ProdEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: !Sub |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json"
                    ],
                    "Json": {
                      "Parameters": {
                        "KCBaseUrl": "CfnDeploy_ProdEU::stack-outputs.json:Domain",
                        "LayerName": "${LayerName}-prodEU"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "prodEU",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: ProjectVersion
                - Name: CfnDeploy_ProdEU
              OutputArtifacts:
                - Name: FinalizedCfnAuthConfig_ProdEU
              RunOrder: 6
            - 
              Name: CfnAuthDeploy_ProdEU_EuCentral1
              Region: eu-central-1
              RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable-auth
                TemplatePath: "AuthPackageEuCentral1::auth.packaged.yml"
                TemplateConfiguration: "FinalizedCfnAuthConfig_ProdEU::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: AuthPackageEuCentral1
                - Name: FinalizedCfnAuthConfig_ProdEU
              OutputArtifacts:
                - Name: CfnAuthDeploy_ProdEU_EuCentral1
              RunOrder: 7
            -
              Name: ImportConfig_ProdEU
              RunOrder: 7
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_ProdEU::stack-outputs.json:CpConfigImportLambdaArn",
                    "Payload": {"ImportId":"{{ codepipeline_job_id }}"},
                    "AccountId": "${ProductionAccountId}",
                    "Region": "eu-central-1",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_ProdEU
            -
              Name: PostDeployApiActions_ProdEU
              RunOrder: 8
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_ProdEU::stack-outputs.json:CpPostDeployLambdaArn",
                    "Payload": { "Actions": [ "rotate_client_secrets","clear_user_cache" ] },
                    "AccountId": "${ProductionAccountId}",
                    "Region": "eu-central-1",
                    "InvocationType": "RequestResponse",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_ProdEU
            - 
              Name: PublishDeployment_ProdEU
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPSetDeploymentContext
                UserParameters: !Sub |
                  {
                    "ProjectId": "${ProjectName}_navexprod_eu-central-1",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "DeploymentContext": "prodEU",
                    "JsonArtifactFiles": [
                      "CfnDeploy_ProdEU::stack-outputs.json",
                      "CfnAuthDeploy_ProdEU_EuCentral1::stack-outputs.json"
                    ]
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: CfnDeploy_ProdEU
                - Name: CfnAuthDeploy_ProdEU_EuCentral1                 
              RunOrder: 9
        - Name: ApproveDeployToProductionUS
          Actions:
            - Name: Production_US_Manual_Gate
              RunOrder: 1
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Version: "1"
                Provider: Manual
        - Name: ProdUS
          Actions:
            - 
              Name: GetDcArt_ProdUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPGetDCArtFromBuildInfo
                UserParameters: !Sub |
                  {
                    "SourceProjectId": "${ProjectName}_navexprod_us-east-1",
                    "DeploymentContext": "prodUS",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "ProjectIds": {"aws-inf": "aws-inf_platform_navexprod_us-east-1"}
                  }
              InputArtifacts:
                - Name: ProjectVersion
              OutputArtifacts:
                - Name: GetDcArt_ProdUS
              RunOrder: 1
            -
              Name: MergeArtifacts_ProdUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPMergeArtifacts
                UserParameters: |
                  {
                    "ArtifactPrefixMap":{
                      "GetDcArt_ProdUS": "dc_art",
                      "App": "app"
                    }
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: GetDcArt_ProdUS
                - Name: App
              OutputArtifacts:
                - Name: MergeArtifacts_ProdUS
              RunOrder: 2
            - 
              Name: Transform_ProdUS
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TransformCodeBuildProject
                EnvironmentVariables: |
                  [
                    {"name": "INCLUDE_ADMIN_USER_IMPORT", "value": "false", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: MergeArtifacts_ProdUS
              OutputArtifacts:
                - Name: Transform_ProdUS
              RunOrder: 3
            - 
              Name: FinalizedCfnConfig_ProdUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json",
                      "BuildOutput::template-configuration.json", 
                      "Transform_ProdUS::template-configuration.json" 
                    ],
                    "Json": {
                      "Parameters": {
                        "Subdomain": "id3",
                        "DnsHostedZone": "navexone.com",
                        "DnsHostedZoneId": "Z29CNCMQKCNU6I",
                        "Stage": "Production",
                        "DesiredTaskCount": "4",
                        "DbaAccessCidr": "10.98.26.14/31"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "prodUS",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      }
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: BuildOutput
                - Name: ProjectVersion
                - Name: Transform_ProdUS
              OutputArtifacts:
                - Name: FinalizedCfnConfig_ProdUS
              RunOrder: 4
            - 
              Name: CfnDeploy_ProdUS
              Region: us-east-1
              RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable
                TemplatePath: "PackageUsEast1::app.packaged.yml"
                TemplateConfiguration: "FinalizedCfnConfig_ProdUS::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: PackageUsEast1
                - Name: FinalizedCfnConfig_ProdUS
              OutputArtifacts:
                - Name: CfnDeploy_ProdUS
              RunOrder: 5
            -
              Name: ConfigUpload_ProdUS          
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              InputArtifacts:
                - Name: Transform_ProdUS
                - Name: CfnDeploy_ProdUS
              Configuration:
                FunctionName: CPS3Deploy
                UserParameters: !Sub |
                  {
                    "S3BucketName": "CfnDeploy_ProdUS::stack-outputs.json:ConfigBucket",
                    "BaseDirectory": "transformed-import",
                    "PurgeDirectories": "enabled",
                    "ExcludeArtifactsFromUpload": ["CfnDeploy_ProdUS"],
                    "AccountId": "${ProductionAccountId}",
                    "Region": "us-east-1"
                  }
              RunOrder: 6
            - 
              Name: FinalizedCfnAuthConfig_ProdUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPUpdateJsonFile
                UserParameters: !Sub |
                  {
                    "JsonFiles": [
                      "App::aws-inf/template-configuration.json"
                    ],
                    "Json": {
                      "Parameters": {
                        "KCBaseUrl": "CfnDeploy_ProdUS::stack-outputs.json:Domain",
                        "LayerName": "${LayerName}-prodUS"
                      },
                      "Tags": {
                        "Navex:Technical:DeploymentContext": "prodUS",
                        "Navex:Technical:Version": "ProjectVersion::build-record.json:Version"
                      } 
                    },
                    "OutputFile": "template-configuration.json"
                  }
              InputArtifacts:
                - Name: App
                - Name: ProjectVersion
                - Name: CfnDeploy_ProdUS
              OutputArtifacts:
                - Name: FinalizedCfnAuthConfig_ProdUS
              RunOrder: 6
            - 
              Name: CfnAuthDeploy_ProdUS_UsEast1
              Region: us-east-1
              RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-codepipelineassume
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Sub arn:aws:iam::${ProductionAccountId}:role/navex-deploymentservice
                StackName: !Sub ${ProjectName}-stable-auth
                TemplatePath: "AuthPackageUsEast1::auth.packaged.yml"
                TemplateConfiguration: "FinalizedCfnAuthConfig_ProdUS::template-configuration.json"
                OutputFileName: stack-outputs.json
              InputArtifacts:
                - Name: AuthPackageUsEast1
                - Name: CfnDeploy_ProdUS
                - Name: FinalizedCfnAuthConfig_ProdUS
              OutputArtifacts:
                - Name: CfnAuthDeploy_ProdUS_UsEast1
              RunOrder: 7
            -
              Name: ImportConfig_ProdUS
              RunOrder: 7
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_ProdUS::stack-outputs.json:CpConfigImportLambdaArn",
                    "Payload": {"ImportId":"{{ codepipeline_job_id }}"},
                    "AccountId": "${ProductionAccountId}",
                    "Region": "us-east-1",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_ProdUS
            -
              Name: PostDeployApiActions_ProdUS
              RunOrder: 8
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPInvokeLambda
                UserParameters: !Sub |
                  {
                    "TargetFunctionName": "CfnDeploy_ProdUS::stack-outputs.json:CpPostDeployLambdaArn",
                    "Payload": { "Actions": [ "rotate_client_secrets","clear_user_cache" ] },
                    "AccountId": "${ProductionAccountId}",
                    "Region": "us-east-1",
                    "InvocationType": "RequestResponse",
                    "ParseResponse": true
                  }
              InputArtifacts:
                - Name: CfnDeploy_ProdUS
            - 
              Name: PublishDeployment_ProdUS
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Version: "1"
                Provider: Lambda
              Configuration:
                FunctionName: CPSetDeploymentContext
                UserParameters: !Sub |
                  {
                    "ProjectId": "${ProjectName}_navexprod_us-east-1",
                    "BuildInfoFile": "ProjectVersion::build-record.json",
                    "DeploymentContext": "prodUS",
                    "JsonArtifactFiles": [
                      "CfnDeploy_ProdUS::stack-outputs.json",
                      "CfnAuthDeploy_ProdUS_UsEast1::stack-outputs.json"
                    ]
                  }
              InputArtifacts:
                - Name: ProjectVersion
                - Name: CfnDeploy_ProdUS
                - Name: CfnAuthDeploy_ProdUS_UsEast1                 
              RunOrder: 9  
